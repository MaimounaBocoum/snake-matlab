function AcoustoOptiqueGUI
% This function is a GUI for launching Acousto-Optic imaging

close all
clearvars

AddPath;

AixplorerIP    = '192.168.1.16';

%% Definition of window

% General figure for the GUI
hf = figure('Visible','on',...
    'units','normalized',...
    'menubar','none',...
    'NumberTitle','off',...
    'Name','Acousto-optics Sequence',...
    'OuterPosition',[0 0.2 0.2 0.6],...
    'tag','hf');

parentcolor = get(hf, 'color');

% General figure for the load sequence GUI
hl = figure('Visible','off',...
    'units','normalized',...
    'menubar','none',...
    'NumberTitle','off',...
    'Name','Load US Sequence',...
    'OuterPosition',[0.5 0.05 0.3 0.9],...
    'tag','hl');

%load sequence button
LOAD = uicontrol('Style', 'pushbutton',...
    'string', 'Load Sequence',...
    'Fontsize',14,...
    'units','normalized',...
    'Position',[0.1 0.82 0.8 0.1],...
    'callback',{@LoadSeq,hf},...
    'tag','LOAD',...
    'parent',hf);

LOADED = uicontrol('Style', 'text',...
    'string', 'Sequence loaded',...
    'visible','off',...
    'horizontalalignment','center',...
    'Fontsize',12,...
    'units','normalized',...
    'Position',[0.05 0.72 0.9 0.1],...
    'BackgroundColor',parentcolor,...
    'callback',{@LoadSeq,hf},...
    'tag','LOADED',...
    'parent',hf);

% Sample rate parameter for acquisition of AO signal
SRText = uicontrol('Style','text',...
    'String','Sampling Rate (MHz)',...
    'BackgroundColor',parentcolor,...
    'horizontalalignment','center',...
    'visible', 'on',...
    'Fontsize',10,...
    'units','normalized',...
    'tag','SRText',...
    'Position',[0.1,0.64,0.3,0.1],...
    'parent',hf);

SREdit = uicontrol('Style','edit',...
    'string','50',...
    'Fontsize',10,...
    'visible', 'on',...
    'enable','off',...
    'units','normalized',...
    'Position',[0.1,0.59,.3,0.07],...
    'backgroundcolor','white',...
    'tag','SREdit',...
    'parent',hf);

% Range parameter for acquisition of AO signal
RangeText = uicontrol('Style','text',...
    'String','Acq. Range (V)',...
    'BackgroundColor',parentcolor,...
    'horizontalalignment','center',...
    'visible', 'on',...
    'Fontsize',10,...
    'units','normalized',...
    'tag','RangeText',...
    'Position',[0.6,0.64,0.3,0.1],...
    'parent',hf);

RangeEdit = uicontrol('Style','edit',...
    'string','0.2',...
    'Fontsize',10,...
    'visible', 'on',...
    'enable','off',...
    'units','normalized',...
    'Position',[0.6,0.59,.3,0.07],...
    'backgroundcolor','white',...
    'tag','RangeEdit',...
    'parent',hf);

% Creates start button
start = uicontrol('Style', 'pushbutton',...
    'string', 'Please load sequence',...
    'Visible','on',...
    'enable','off',...
    'Fontsize',16,...
    'units','normalized',...
    'Position',[0.1 0.44 0.8 0.1],...
    'callback',{@startAcquisition},...
    'tag','start',...
    'parent',hf);


% Data file name
NameText = uicontrol('Style','text',...
    'String','File name',...
    'BackgroundColor',parentcolor,...
    'horizontalalignment','left',...
    'visible', 'on',...
    'Fontsize',12,...
    'units','normalized',...
    'tag','NameText',...
    'Position',[0.05,0.32,0.9,0.07],...
    'parent',hf);

NameEdit = uicontrol('Style','edit',...
    'string','DefaultName',...
    'Fontsize',12,...
    'visible', 'on',...
    'enable', 'off',...
    'units','normalized',...
    'Position',[0.05,0.28,.90,0.07],...
    'backgroundcolor','white',...
    'tag','NameEdit',...
    'parent',hf);

% save checkbox
SaveBox = uicontrol('Style', 'checkbox',...
    'string', 'Save',...
    'Visible','on',...
    'value',0,...
    'Fontsize',12,...
    'units','normalized',...
    'horizontalalignment','right',...
    'Position',[0.7,0.35,0.25,0.05],...
    'backgroundcolor',parentcolor,...
    'callback',{@saveON},...
    'tag','SaveBox',...
    'parent',hf);

% Data folder
FolderText = uicontrol('Style','text',...
    'String','Folder',...
    'BackgroundColor',parentcolor,...
    'horizontalalignment','left',...
    'visible', 'on',...
    'Fontsize',12,...
    'units','normalized',...
    'tag','FolderText',...
    'Position',[0.05,0.19,0.9,0.07],...
    'parent',hf);

FolderEdit = uicontrol('Style','edit',...
    'string','D:\Data\Manip en cours',...
    'Fontsize',12,...
    'visible', 'on',...
    'enable','off',...
    'units','normalized',...
    'Position',[0.05,0.15,0.70,0.07],...
    'tag','FolderEdit',...
    'parent',hf);

FolderButton = uicontrol('Style', 'pushbutton',...
    'string', 'Browse',...
    'Fontsize',11,...
    'BackgroundColor',parentcolor,...
    'enable','off',...
    'visible', 'on',...
    'units','normalized',...
    'Position',[0.75,0.15,0.20,0.07],...
    'callback',{@browse},...
    'tag','FolderButton',...
    'parent',hf);

% exit button
Exit = uicontrol('Style', 'pushbutton',...
    'string', 'Exit',...
    'Visible','on',...
    'Fontsize',16,...
    'units','normalized',...
    'Position',[0.6 0.02 0.3 0.1],...
    'callback',{@exitGUI},...
    'tag','Exit',...
    'parent',hf);


%% Base code
AO = guihandles(hf);
AO.parentcolor=parentcolor;
AO.hl=hl;

guidata(hf,AO);


% Displays the figure
set(hf,'visible','on');

%% Callback functions

    function LoadSeq(source, eventdata,hf)
        if findobj('type','figure','tag','hl')
            set(hl,'visible','on')
        else
            hl = figure('Visible','on',...
                'units','normalized',...
                'menubar','none',...
                'NumberTitle','off',...
                'Name','Load US Sequence',...
                'OuterPosition',[0.5 0.05 0.3 0.9],...
                'tag','hl');
        end
        
        loadSEQ(hf);
    end

    function data=startAcquisition(source, eventdata)
        
        AO=guidata(hf);
        AO.SamplingRate=str2double(get(AO.SREdit,'string'));
        AO.Range=str2double(get(AO.RangeEdit,'string'));
        
        AO.Name = get(AO.NameEdit,'string');
        AO.Save = get(AO.SaveBox,'value');
        AO.Path = get(AO.FolderEdit,'string');
        display('Encore du travail ?')
        %         SEQ=AO.SEQ;
        
        %Scp=InitTiePie(AO);
        %data=AcqTiePie(Scp,AO);
        
        %         SEQ = SEQ.startSequence();
        
        
        [~,handle,AO.actNTrig]=InitGage(AO);
        data=AcqGage(handle,AO);
        
        Y = linspace(0,AO.Prof,size(data,1));
        X = linspace(AO.X0,AO.X0+AO.ScanLength,size(data,2));
        figure(1123)
        imagesc(X,Y,data)
        axis equal
        
        if(AO.Save == 1)
            display(['Saving data in ' AO.Path])
            SaveData(data,X,Y,AO);
        end
        
        display('Travail Terminé')
        %plot(data)
        
        %         %         axis([1 length(date) -0.1 0.1])
        %         figure(1124)
        %         plot(tsdata)
    end

    function saveON(source,eventdata)
        saving = get(source,'value');
        if saving == 1
            set(AO.FolderEdit,'enable','on')
            set(AO.NameEdit,'enable','on')
            set(AO.FolderButton,'enable','on')
        else
            set(AO.FolderEdit,'enable','off')
            set(AO.NameEdit,'enable','off')
            set(AO.FolderButton,'enable','off')
        end
    end

    function browse(source,eventdata)
        dir = uigetdir(get(AO.FolderEdit,'string'));
        if dir ~=0
            set(AO.FolderEdit,'string',dir)
        end
        AO.Path = get(AO.FolderEdit,'string');
    end

    function exitGUI(source, eventdata)
        clearvars
        close all
    end

end