%% Load and execute a long sequence (1 min duration

% Initialization
clear all; close all; clc; clear classes;
IPaddress = '192.168.1.48';
NbRepeat  = 1e4;

%% HIFU sequence with no acquisition

LTE1 = usse.lte();
LTE1 = LTE1.addHifu( ...
    'HifuFreq', 1.2, ...
    'FiringDuration', 0.1, ...
    'TransmitElemts', 1:system.hardware.NbTxChan, ...
    'Phase', 0, ...
    'MaxDuty', 0, ...
    'RxFreq', 45, ...
    'AcqDuration', 0, ...
    'RcvElemts', 1:20:256, ...
    'TriggerMode', 0, ...
    'TgcControlPts', 950/8 * (1:8), ...
    'Repeat', 1);

% Build the REMOTE structure
[LTE1 NbAcq1] = LTE1.buildRemote();

%% HIFU sequence with acquisition

LTE2 = usse.lte();
LTE2 = LTE2.addHifu( ...
    'HifuFreq', 1.2, ...
    'FiringDuration', 0.1, ...
    'TransmitElemts', 1:system.hardware.NbTxChan, ...
    'Phase', 0, ...
    'MaxDuty', 0, ...
    'RxFreq', 45, ...
    'AcqDuration', 0, ...
    'RcvElemts', 1:20:256, ...
    'TriggerMode', 0, ...
    'TgcControlPts', 950/8 * (1:8), ...
    'Repeat', 1);
LTE2 = LTE2.addHifu( ...
    'HifuFreq', 1.2, ...
    'FiringDuration', 0.1, ...
    'TransmitElemts', 1:system.hardware.NbTxChan, ...
    'Phase', 0, ...
    'MaxDuty', 0, ...
    'RxFreq', 45, ...
    'AcqDuration', 1e-4, ...
    'RcvElemts', 1:20:256, ...
    'TriggerMode', 0, ...
    'TgcControlPts', 950/8 * (1:8), ...
    'Repeat', 1);

% Build the REMOTE structure
[LTE2 NbAcq2] = LTE2.buildRemote();

%% 1st HIFU sequence execution

% Initialize remote mode
LTE1    = LTE1.initializeRemote('IPaddress', IPaddress);

% Load sequence
LTE1 = LTE1.loadSequence();

% Execute sequences
wb = waitbar(0, 'Sequence execution...');
for k = 1 : NbRepeat

    % Load and execute 1st sequence
    LTE1 = LTE1.startSequence('Wait', 1);
    for l = 1 : NbAcq1
        buffer1(l) = LTE1.getData();
    end
    LTE1 = LTE1.stopSequence('Wait', 1);

    % Update progress bar
    waitbar(k / NbRepeat, wb);

end
close(wb);

%% 2nd HIFU sequence execution

% Initialize remote mode
LTE2    = LTE2.initializeRemote('IPaddress', IPaddress);

% Load sequence
LTE2 = LTE2.loadSequence();

% Execute sequences
wb = waitbar(0, 'Sequence execution...');
for k = 1 : NbRepeat

    % Load and execute 1st sequence
    LTE2 = LTE2.startSequence('Wait', 1);
    for l = 1 : NbAcq2
        buffer2(l) = LTE2.getData();
    end
    LTE2 = LTE2.stopSequence('Wait', 1);

    % Update progress bar
    waitbar(k / NbRepeat, wb);

end
close(wb);
