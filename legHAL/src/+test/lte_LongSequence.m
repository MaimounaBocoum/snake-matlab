%% Load and execute a long sequence (1 min duration)

% Initialization
clear all; close all; clc; clear classes;
IPaddress = '192.168.1.48';
NbRepeat  = 10;

% Long HIFU sequence with acquisition
LTE = usse.lte();
LTE = LTE.addHifu( ...
    'HifuFreq', 1.2, ...
    'FiringDuration', 1, ...
    'TransmitElemts', 1:system.hardware.NbTxChan, ...
    'Phase', 0, ...
    'MaxDuty', 0, ...
    'RxFreq', 45, ...
    'AcqDuration', 0, ...
    'RcvElemts', 1:20:256, ...
    'TriggerMode', 0, ...
    'TgcControlPts', 950/8 * (1:8), ...
    'Repeat', 10);
LTE = LTE.addHifu( ...
    'HifuFreq', 1.2, ...
    'FiringDuration', 1, ...
    'TransmitElemts', 1:system.hardware.NbTxChan, ...
    'Phase', 0, ...
    'MaxDuty', 0, ...
    'RxFreq', 45, ...
    'AcqDuration', 1e-4, ...
    'RcvElemts', 1:20:256, ...
    'TriggerMode', 0, ...
    'TgcControlPts', 950/8 * (1:8), ...
    'Repeat', 1);
LTE = LTE.addHifu( ...
    'HifuFreq', 1.2, ...
    'FiringDuration', 1, ...
    'TransmitElemts', 1:system.hardware.NbTxChan, ...
    'Phase', 0, ...
    'MaxDuty', 0, ...
    'RxFreq', 45, ...
    'AcqDuration', 0, ...
    'RcvElemts', 1:20:256, ...
    'TriggerMode', 0, ...
    'TgcControlPts', 950/8 * (1:8), ...
    'Repeat', 10);
LTE = LTE.addHifu( ...
    'HifuFreq', 1.2, ...
    'FiringDuration', 1, ...
    'TransmitElemts', 1:system.hardware.NbTxChan, ...
    'Phase', 0, ...
    'MaxDuty', 0, ...
    'RxFreq', 45, ...
    'AcqDuration', 1e-4, ...
    'RcvElemts', 1:20:256, ...
    'TriggerMode', 0, ...
    'TgcControlPts', 950/8 * (1:8), ...
    'Repeat', 1);
LTE = LTE.addHifu( ...
    'HifuFreq', 1.2, ...
    'FiringDuration', 1, ...
    'TransmitElemts', 1:system.hardware.NbTxChan, ...
    'Phase', 0, ...
    'MaxDuty', 0, ...
    'RxFreq', 45, ...
    'AcqDuration', 0, ...
    'RcvElemts', 1:20:256, ...
    'TriggerMode', 0, ...
    'TgcControlPts', 950/8 * (1:8), ...
    'Repeat', 10);
LTE = LTE.addHifu( ...
    'HifuFreq', 1.2, ...
    'FiringDuration', 1, ...
    'TransmitElemts', 1:system.hardware.NbTxChan, ...
    'Phase', 0, ...
    'MaxDuty', 0, ...
    'RxFreq', 45, ...
    'AcqDuration', 1e-4, ...
    'RcvElemts', 1:20:256, ...
    'TriggerMode', 0, ...
    'TgcControlPts', 950/8 * (1:8), ...
    'Repeat', 1);
LTE = LTE.addHifu( ...
    'HifuFreq', 1.2, ...
    'FiringDuration', 1, ...
    'TransmitElemts', 1:system.hardware.NbTxChan, ...
    'Phase', 0, ...
    'MaxDuty', 0, ...
    'RxFreq', 45, ...
    'AcqDuration', 0, ...
    'RcvElemts', 1:20:256, ...
    'TriggerMode', 0, ...
    'TgcControlPts', 950/8 * (1:8), ...
    'Repeat', 10);
LTE = LTE.addHifu( ...
    'HifuFreq', 1.2, ...
    'FiringDuration', 1, ...
    'TransmitElemts', 1:system.hardware.NbTxChan, ...
    'Phase', 0, ...
    'MaxDuty', 0, ...
    'RxFreq', 45, ...
    'AcqDuration', 1e-4, ...
    'RcvElemts', 1:20:256, ...
    'TriggerMode', 0, ...
    'TgcControlPts', 950/8 * (1:8), ...
    'Repeat', 1);
LTE = LTE.addHifu( ...
    'HifuFreq', 1.2, ...
    'FiringDuration', 1, ...
    'TransmitElemts', 1:system.hardware.NbTxChan, ...
    'Phase', 0, ...
    'MaxDuty', 0, ...
    'RxFreq', 45, ...
    'AcqDuration', 0, ...
    'RcvElemts', 1:20:256, ...
    'TriggerMode', 0, ...
    'TgcControlPts', 950/8 * (1:8), ...
    'Repeat', 10);
LTE = LTE.addHifu( ...
    'HifuFreq', 1.2, ...
    'FiringDuration', 1, ...
    'TransmitElemts', 1:system.hardware.NbTxChan, ...
    'Phase', 0, ...
    'MaxDuty', 0, ...
    'RxFreq', 45, ...
    'AcqDuration', 1e-4, ...
    'RcvElemts', 1:20:256, ...
    'TriggerMode', 0, ...
    'TgcControlPts', 950/8 * (1:8), ...
    'Repeat', 1);

% Build the REMOTE structure
[LTE NbAcq] = LTE.buildRemote();

% Estimate the sequence duration
Duration = 0;
for k = 1 : length(LTE.InfoStruct.event)
    Duration = Duration + double(LTE.InfoStruct.event(k).duration);
end
disp(['The sequence lasts for ' num2str(Duration * 1e-6) ' seconds...']);

%% Sequence execution

% Initialize remote mode
LTE    = LTE.initializeRemote('IPaddress', IPaddress);

% Load sequence
LTE = LTE.loadSequence();

% Execute sequences
wb = waitbar(0, 'Sequence execution...');
for k = 1 : NbRepeat
    
    % Load and execute 1st sequence
    LTE = LTE.startSequence('Wait', 1);
    for l = 1 : NbAcq
        buffer(l) = LTE.getData();
    end
    LTE = LTE.stopSequence('Wait', 1);

    % Update progress bar
    waitbar(k / NbRepeat, wb);

end
close(wb);
