%% Load and execute sequences with different triggers

% Initialization
clear all; close all; clc; clear classes;
IPaddress = '192.168.1.48';
NbRepeat  = 1;

% No triggers
LTE1 = usse.lte();
LTE1 = LTE1.addHifu( ...
    'HifuFreq', 1.2, ...
    'FiringDuration', 0.1, ...
    'TransmitElemts', 1:system.hardware.NbTxChan, ...
    'Phase', 0, ...
    'MaxDuty', 0, ...
    'RxFreq', 45, ...
    'AcqDuration', 91e-6, ...
    'RcvElemts', 1:20:256, ...
    'TriggerMode', 0, ...
    'TgcControlPts', 950/8 * (1:8), ...
    'Repeat', 2);
LTE1 = LTE1.addImaging( ...
    'TrFreq', 1, ...
    'NCycles', 3, ...
    'TransmitElemts', 1:256, ...
    'Delays', zeros(1,256), ...
    'MaxDuty', 0, ...
    'RxFreq', 20, ...
    'AcqDuration', 51.1, ...
    'RcvElemts', 1:10:256, ...
    'TgcControlPts', 950/8 * (1:8), ...
    'TriggerMode', 0, ...
    'Repeat', 2);
    
% Trigger IN
LTE2 = usse.lte();
LTE2 = LTE2.addHifu( ...
    'HifuFreq', 1.2, ...
    'FiringDuration', 0.1, ...
    'TransmitElemts', 1:system.hardware.NbTxChan, ...
    'Phase', 0, ...
    'MaxDuty', 0, ...
    'RxFreq', 45, ...
    'AcqDuration', 91e-6, ...
    'RcvElemts', 1:20:256, ...
    'TriggerMode', 1, ...
    'TgcControlPts', 950/8 * (1:8), ...
    'Repeat', 2);
LTE2 = LTE2.addImaging( ...
    'TrFreq', 1, ...
    'NCycles', 3, ...
    'TransmitElemts', 1:256, ...
    'Delays', zeros(1,256), ...
    'MaxDuty', 0, ...
    'RxFreq', 20, ...
    'AcqDuration', 51.1, ...
    'RcvElemts', 1:10:256, ...
    'TgcControlPts', 950/8 * (1:8), ...
    'TriggerMode', 1, ...
    'Repeat', 2);
    
% Trigger OUT
LTE3 = usse.lte();
LTE3 = LTE3.addHifu( ...
    'HifuFreq', 1.2, ...
    'FiringDuration', 0.1, ...
    'TransmitElemts', 1:system.hardware.NbTxChan, ...
    'Phase', 0, ...
    'MaxDuty', 0, ...
    'RxFreq', 45, ...
    'AcqDuration', 91e-6, ...
    'RcvElemts', 1:20:256, ...
    'TriggerMode', 2, ...
    'TgcControlPts', 950/8 * (1:8), ...
    'Repeat', 2);
LTE3 = LTE3.addImaging( ...
    'TrFreq', 1, ...
    'NCycles', 3, ...
    'TransmitElemts', 1:256, ...
    'Delays', zeros(1,256), ...
    'MaxDuty', 0, ...
    'RxFreq', 20, ...
    'AcqDuration', 51.1, ...
    'RcvElemts', 1:10:256, ...
    'TgcControlPts', 950/8 * (1:8), ...
    'TriggerMode', 2, ...
    'Repeat', 2);
    
% Triggers IN/OUT
LTE4 = usse.lte();
LTE4 = LTE4.addHifu( ...
    'HifuFreq', 1.2, ...
    'FiringDuration', 0.1, ...
    'TransmitElemts', 1:system.hardware.NbTxChan, ...
    'Phase', 0, ...
    'MaxDuty', 0, ...
    'RxFreq', 45, ...
    'AcqDuration', 91e-6, ...
    'RcvElemts', 1:20:256, ...
    'TriggerMode', 3, ...
    'TgcControlPts', 950/8 * (1:8), ...
    'Repeat', 2);
LTE4 = LTE4.addImaging( ...
    'TrFreq', 1, ...
    'NCycles', 3, ...
    'TransmitElemts', 1:256, ...
    'Delays', zeros(1,256), ...
    'MaxDuty', 0, ...
    'RxFreq', 20, ...
    'AcqDuration', 51.1, ...
    'RcvElemts', 1:10:256, ...
    'TgcControlPts', 950/8 * (1:8), ...
    'TriggerMode', 3, ...
    'Repeat', 2);
    
% Build the REMOTE structure
[LTE1 NbAcq1] = LTE1.buildRemote();
[LTE2 NbAcq2] = LTE2.buildRemote();
[LTE3 NbAcq3] = LTE3.buildRemote();
[LTE4 NbAcq4] = LTE4.buildRemote();

%% Sequence execution

% Initialize remote mode
LTE1    = LTE1.initializeRemote('IPaddress', IPaddress);
LTE2    = LTE2.initializeRemote('IPaddress', IPaddress);
LTE3    = LTE3.initializeRemote('IPaddress', IPaddress);
LTE4    = LTE4.initializeRemote('IPaddress', IPaddress);

% Execute sequences
wb = waitbar(0, '1st sequence running...');
for k = 1 : NbRepeat
    
    % Load and execute 1st sequence
    LTE1 = LTE1.loadSequence();
    LTE1 = LTE1.startSequence('Wait', 1);
    for l = 1 : NbAcq1
        buffer1(l) = LTE1.getData();
    end
    LTE1 = LTE1.stopSequence('Wait', 1);

    % Update progress bar
    waitbar((4*(k-1) + 1) / (4 * NbRepeat), wb, '2nd sequence running...');

    % Load and execute 2nd sequence
    LTE2 = LTE2.loadSequence();
    LTE2 = LTE2.startSequence('Wait', 1);
    for l = 1 : NbAcq2
        buffer2(l) = LTE2.getData();
    end
    LTE2 = LTE2.stopSequence('Wait', 1);

    % Update progress bar
    waitbar((4*(k-1) + 2) / (4 * NbRepeat), wb, '3rd sequence running...');

    % Load and execute 3rd sequence
    LTE3 = LTE3.loadSequence();
    LTE3 = LTE3.startSequence('Wait', 1);
    for l = 1 : NbAcq3
        buffer3(l) = LTE3.getData();
    end
    LTE3 = LTE3.stopSequence('Wait', 1);

    % Update progress bar
    waitbar((4*(k-1) + 3) / (4 * NbRepeat), wb, '4th sequence running...');

    % Load and execute 4th sequence
    LTE4 = LTE4.loadSequence();
    LTE4 = LTE4.startSequence('Wait', 1);
    for l = 1 : NbAcq4
        buffer4(l) = LTE4.getData();
    end
    LTE4 = LTE4.stopSequence('Wait', 1);

    % Update progress bar
    waitbar((4*(k-1) + 4) / (4 * NbRepeat), wb, '1st sequence running...');

end
close(wb);
